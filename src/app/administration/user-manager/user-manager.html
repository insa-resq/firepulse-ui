<div class="admin-container-wrapper">
  <div class="admin-container">
    <h1>Gestion des utilisateurs</h1>

    <!-- Message de feedback -->
    @if(message) {
      <div [class]="'alert ' + (messageSuccess ? 'alert-success' : 'alert-error')">
        {{ message }}
      </div>
    }

    <!-- Loading state -->
    @if(isLoading) {
      <div class="loading">Chargement des utilisateurs...</div>
    }

    <!-- Users list -->
    @if(!isLoading && users.length > 0) {
      <div class="users-section">
        <div class="users-header">
          <h2>Liste des utilisateurs ({{ users.length }})</h2>
        </div>

        <!-- Recherche et Filtres -->
        <div class="filters-container">
          <div class="filters-header">
            <h3>üîç Recherche et filtres</h3>
          </div>

          <div class="search-box">
            <div class="search-input-wrapper">
              <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input
                type="text"
                [(ngModel)]="searchEmail"
                placeholder="Rechercher par adresse email..."
                class="search-input"
              />
              @if(searchEmail) {
                <button class="clear-search" (click)="searchEmail = ''" title="Effacer la recherche">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              }
            </div>
          </div>

          <div class="filters-row">
            <div class="filter-group">
              <label class="filter-label">Caserne</label>
              <select [(ngModel)]="filterStation" class="filter-select">
                <option value="">Toutes les casernes</option>
                @for(station of getSortedStations(); track station) {
                  <option [value]="station">
                    {{ stationNames[station] || station }}
                  </option>
                }
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">R√¥le</label>
              <select [(ngModel)]="filterRole" class="filter-select">
                <option value="">Tous les r√¥les</option>
                <option value="ALERT_MONITOR">Moniteur d'alerte</option>
                <option value="PLANNING_MANAGER">Gestionnaire de planning</option>
                <option value="FIREFIGHTER">Pompier</option>
              </select>
            </div>

            @if(searchEmail || filterStation || filterRole) {
              <button class="btn btn-reset" (click)="resetFilters()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                  <path d="M21 3v5h-5"/>
                  <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                  <path d="M3 21v-5h5"/>
                </svg>
                R√©initialiser
              </button>
            }
          </div>
        </div>

        <!-- R√©sultats du filtrage -->
        @if(getFilteredUsers().length === 0 && (searchEmail || filterStation || filterRole)) {
          <div class="no-results">
            <p>Aucun utilisateur ne correspond aux crit√®res de recherche</p>
          </div>
        }

        <div class="users-grid">
          @for(user of getFilteredUsers(); track user.id) {
            <div class="user-card">
              <!-- User Info -->
              <div class="user-info">
                <div class="user-header-row">
                  <div class="user-details">
                    <div class="user-email">{{ user.email.split('@')[0] }}</div>
                    <div class="user-meta">
                      <span class="user-role" [class]="'user-role user-role-' + user.role.toLowerCase()">{{ getRoleName(user.role) }}</span>
                    </div>
                  </div>
                </div>

                <!-- Edit Mode -->
                @if(editingUserId === user.id) {
                  <div class="edit-form">
                    <div class="form-group">
                      <label>Email</label>
                      <input type="email" [(ngModel)]="editEmail" placeholder="Entrez l'email" />
                    </div>
                    <div class="form-group">
                      <label>Caserne</label>
                      <select [(ngModel)]="editStationId" class="form-select">
                        <option value="">-- S√©lectionner une caserne --</option>
                        @for(station of getSortedStations(); track station) {
                          <option [value]="station">
                            {{ stationNames[station] || station }}
                          </option>
                        }
                      </select>
                    </div>
                    <div class="form-actions">
                      <button class="btn btn-save" (click)="updateUser(user)">Enregistrer</button>
                      <button class="btn btn-cancel" (click)="cancelEdit()">Annuler</button>
                    </div>
                  </div>
                } @else {
                  <!-- Display Mode -->
                  <div class="user-display">
                    <div class="info-row">
                      <span class="label">Email :</span>
                      <span class="value">{{ user.email }}</span>
                    </div>
                    @if(user.stationId) {
                      <div class="info-row">
                        <span class="label">Caserne :</span>
                        @if(loadingStations.has(user.stationId)) {
                          <span class="value loading-station">
                          Chargement...
                        </span>
                        } @else {
                          <span class="value">{{ stationNames[user.stationId] || user.stationId }}</span>
                        }
                      </div>
                    }
                  </div>
                }
              </div>

              <!-- Actions -->
              @if(editingUserId !== user.id) {
                <div class="user-actions">
                  <button class="btn btn-edit" (click)="startEdit(user)">Modifier</button>
                  <button class="btn btn-delete" (click)="deleteUser(user)">Supprimer</button>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    <!-- Empty state -->
    @if(!isLoading && users.length === 0) {
      <div class="empty-state">
        <p>Aucun utilisateur trouv√©</p>
      </div>
    }
  </div>
</div>
